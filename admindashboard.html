<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="./assets/CSS/style.css">
  <link rel="stylesheet" href="./assets/CSS/blogs.css">
  <link rel="stylesheet" href="./assets/CSS/admindashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
  <style>
    /* CSS for toast messages */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
    .toast {
      background-color: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      margin-bottom: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .toast.show {
      opacity: 1;
    }
    .toast-info {
      background-color: #333;
    }
    .toast-success {
      background-color: #28a745;
    }
    .toast-error {
      background-color: #dc3545;
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div>
      <h3>Admin Dashboard</h3>
    </div>
    <div style="display: flex; gap: 10px;">
      <div><img src="./assets/images/dash.jpg" alt="" style=" width: 50px; height: 45px; border-radius: 500px;"></div>
      <div><h4>Maurice</h4></div>
    </div>
  </header>
  <input type="checkbox" id="check">
  <label for="check">
    <i class="fas fa-bars" id="btn"></i>
    <i class="fas fa-times" id="cancel"></i>
  </label>
  <div class="sidebar">
    <a href="#" class="active">
      <i class="fas fa-qrcode"></i>
      <span>Dashboard</span>
    </a>
    <a href="#">
      <i class="fas fa-stream"></i>
      <span>Blogs</span>
    </a>
    <a href="addblog.html">
      <i class="fas fa-calendar"></i>
      <span>Add Blog</span>
    </a>
    <a href="adminqueries.html">
      <i class="fas fa-calendar"></i>
      <span>Queries</span>
    </a>
    <a href="index.html">
      <i class="fas fa-calendar"></i> 
      <span>Home</span>
    </a>
  </div>

  <div class="blog-cards-container" id="blog-cards-container"></div>
  <div class="chart-container">
    <div id="piechart" style="width: 800px; height: 500px;"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Edit Blog Post</h2>
      <form id="editForm">
        <input type="hidden" id="editBlogId" name="editBlogId"> <!-- Hidden input field to store blogId -->
        <label for="editTitle">Title:</label><br>
        <input type="text" id="editTitle" name="editTitle"><br>
        <label for="editDate">Date:</label><br>
        <input type="text" id="editDate" name="editDate"><br>
        <label for="editPicture">Picture URL:</label><br> 
        <input type="text" id="editPicture" name="editPicture"><br> 
        <label for="editDescription">Description:</label><br>
        <textarea id="editDescription" name="editDescription"></textarea><br>
        <button type="submit" class="edit-submit-btn">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    const blogContainer = document.getElementById('blog-cards-container');

    // Function to display toast message
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.classList.add('toast', `toast-${type}`);
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000); // Adjust the time as needed
    }

    // Function to fetch and populate edit form with blog data
    async function populateEditForm(blogId) {
      try {
        const response = await fetch(`https://portfolio-backend-xewv.onrender.com/api/singleblogs/${blogId}`);
        if (response.ok) {
          const blogData = await response.json();
          // Populate the edit form fields with the fetched information
          document.getElementById('editTitle').value = blogData.title;
          document.getElementById('editDate').value = blogData.date;
          document.getElementById('editPicture').value = blogData.picture;
          document.getElementById('editDescription').value = blogData.description;
        } else {
          showToast('Failed to fetch blog details. Please try again later.', 'error');
        }
      } catch (error) {
        console.error('Error fetching blog details:', error);
        showToast('An error occurred while fetching blog details. Please try again later.', 'error');
      }
    }

    // Fetch blogs from the backend API
    fetch('https://portfolio-backend-xewv.onrender.com/api/get/blogs')
      .then(response => response.json()) // Parse the JSON response
      .then(data => { // Handle the retrieved data
        data.forEach(blog => {
          // Create a new div element for the blog card
          const blogCard = document.createElement('div');
          blogCard.classList.add('blog-card'); // Add the CSS class for styling

          // Populate the blog card with HTML content, including the blog title, picture, date, and description
          blogCard.innerHTML = `
            <div class="blog-content">
              <img src="${blog.picture}" alt="Blog Picture">
            </div>
            <div class="all">
              <div class="blog-header">
                <h2>${blog.title}</h2>
                <p class="card-date">Date: ${blog.date}</p>
                <p>${blog.description}</p>
              </div>
              <div class="blog-actions"> 
                <button class="edit-button" data-id="${blog._id}">Edit</button> <!-- Add an edit button with data-id attribute containing blog ID -->
                <button class="delete-button" data-id="${blog._id}">Delete</button> <!-- Add a delete button with data-id attribute containing blog ID -->
              </div>
            </div>
          `;  

          blogContainer.appendChild(blogCard); // Append the blog card to the container
        });

        // Add event listener for edit buttons
        document.querySelectorAll('.edit-button').forEach(button => {
          button.addEventListener('click', async function(event) {
            const blogId = event.target.dataset.id;
            const modal = document.getElementById('editModal');
            const closeBtn = modal.querySelector('.close');
            modal.style.display = 'block';

            // Populate the edit form with blog data
            await populateEditForm(blogId);
            // Set the value of editBlogId hidden input field with the current blogId
            document.getElementById('editBlogId').value = blogId;

            // Close the modal when the close button is clicked
            closeBtn.addEventListener('click', function() {
              modal.style.display = 'none';
            });

            // Close the modal when clicking outside the modal content
            window.addEventListener('click', function(event) {
              if (event.target == modal) {
                modal.style.display = 'none';
              }
            });
          });
        });

        // Add event listener for delete buttons
        document.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', async function(event) {
            const blogId = event.target.dataset.id;
            try {
              const response = await fetch(`https://portfolio-backend-xewv.onrender.com/api/blogs/delete/${blogId}`, {
                method: 'DELETE'
              });
              if (response.ok) {
                event.target.closest('.blog-card').remove();
                showToast('Blog deleted successfully.', 'success');
              } else {
                showToast('Failed to delete blog. Please try again later.', 'error');
              }
            } catch (error) {
              console.error('Error deleting blog:', error);
              showToast('An error occurred while deleting the blog. Please try again later.', 'error');
            }
          });
        });
      });

    // Add event listener for edit form submission
    document.getElementById('editForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const blogId = document.getElementById('editBlogId').value;

      const editedBlog = {
        title: document.getElementById('editTitle').value,
        date: document.getElementById('editDate').value,
        picture: document.getElementById('editPicture').value,
        description: document.getElementById('editDescription').value
      };
      try {
        const editResponse = await fetch(`https://portfolio-backend-xewv.onrender.com/api/blogs/edit/${blogId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(editedBlog)
        });
        if (editResponse.ok) {
          showToast('Blog edited successfully.', 'success');
          // Reload the page to reflect the changes
          location.reload();
        } else {
          showToast('Failed to edit blog. Please try again later.', 'error');
        }
      } catch (error) {
        console.error('Error editing blog:', error);
        showToast('An error occurred while editing the blog. Please try again later.', 'error');
      }
    });



const cookie = document.cookie.split('jwt=')[1];
    fetch('https://portfolio-backend-xewv.onrender.com/api/user', {
        credentials: 'include',
        headers: {
            "Authorization": `Bearer ${cookie}`
        }
    })
        .then(response => response.json())
        .then(user => {
        if (!user.isAdmin) {
            window.location.href = "index.html";
        }
        else {
            updateUserUI(user);
        }
    })
        .catch(error => console.error('Error fetching user data:', error));

  </script>


<!-- pie chart -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {

        var data = google.visualization.arrayToDataTable([
          ['Task', 'Hours per Day'],
          ['Blogs',     11],
          ['Users',      2],
          ['Likes',  2],
          ['Querries', 2],
        ]);

        var options = {
          title: 'My Daily Activities'
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));

        chart.draw(data, options);
      }
    </script>


      
</body>
</html>
